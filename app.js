const modalOverlay=document.getElementById("successModal"),installBtn=document.getElementById("installButton"),leadForm=document.getElementById("leadForm"),loadingMsg=document.getElementById("loadingMsg"),errorMsg=document.getElementById("formErrorMsg"),darkModeToggle=document.getElementById("dark-mode-toggle"),fadeElems=document.querySelectorAll(".fade-in-element"),mainHeader=document.querySelector(".main-header");document.addEventListener("DOMContentLoaded",()=>{const a=document.querySelectorAll(".gallery-image"),b=document.createElement("div");b.classList.add("lightbox"),b.innerHTML='\n <button class="lightbox-close" aria-label="Tutup">&times;</button>\n <img src="" alt="Preview" />\n ';document.body.appendChild(b);const c=b.querySelector("img"),d=b.querySelector(".lightbox-close");let e=1,f=!1,g=!1,h,i,j=0,k=0;function l(){e=1,j=0,k=0,c.style.transform="translate(0, 0) scale(1)"}a.forEach(a=>{a.addEventListener("click",()=>{l(),c.src=a.src,b.classList.add("active")})}),d.addEventListener("click",()=>b.classList.remove("active")),b.addEventListener("click",a=>{a.target===b&&b.classList.remove("active")}),b.addEventListener("wheel",a=>{a.preventDefault(),a.deltaY<0?e=Math.min(e+.2,5):e=Math.max(e-.2,1),1===e?l():e>1?c.style.transform=`translate(${j}px, ${k}px) scale(${e})`:c.style.transform="translate(0, 0) scale(1)"}),c.addEventListener("mousedown",a=>{if(!(e<=1)){f=!0,g=!1,h=a.clientX-j,i=a.clientY-k,c.style.cursor="grabbing",a.preventDefault()}}),window.addEventListener("mouseup",()=>{f=!1,c.style.cursor="grab"}),c.addEventListener("mousemove",a=>{if(f){const b=a.clientX-h,d=a.clientY-i,l=c.offsetWidth*e,m=c.offsetHeight*e,n=window.innerWidth,o=window.innerHeight;j=Math.max(-.5*(l-n),Math.min(b,.5*(l-n))),k=Math.max(-.5*(m-o),Math.min(d,.5*(m-o))),g||(Math.abs(b)>5||Math.abs(d)>5)&&(g=!0),c.style.transform=`translate(${j}px, ${k}px) scale(${e})`}}),b.addEventListener("click",a=>{g&&(a.stopPropagation(),g=!1)},!0)}),darkModeToggle&&darkModeToggle.addEventListener("click",()=>{document.body.classList.toggle("dark-mode"),localStorage.setItem("darkMode",document.body.classList.contains("dark-mode")?"enabled":"disabled")}),"enabled"===localStorage.getItem("darkMode")&&document.body.classList.add("dark-mode");const observer=new IntersectionObserver(a=>{a.forEach(a=>{a.isIntersecting&&(a.target.classList.add("is-visible"),observer.unobserve(a.target))})},{threshold:.2});fadeElems.forEach(a=>observer.observe(a)),mainHeader&&window.addEventListener("scroll",()=>{window.scrollY>50?mainHeader.classList.add("scrolled"):mainHeader.classList.remove("scrolled")});const getCookie=a=>{const b=`; ${document.cookie}`,c=b.split(`; ${a}=`);return 2===c.length?c.pop().split(";").shift():null},getQueryParams=()=>{"URLSearchParams"in window;const a=new URLSearchParams(window.location.search);return{ttclid:a.get("ttclid"),fbclid:a.get("fbclid")}},getClientInfo=()=>{let a=localStorage.getItem("sessionId");return a||(a=crypto.randomUUID(),localStorage.setItem("sessionId",a)),{sessionId:a,url:window.location.href,referrer:document.referrer,userAgent:navigator.userAgent,fbc:getCookie("_fbc"),fbp:getCookie("_fbp"),ttp:getCookie("_ttp"),...getQueryParams()}},trackEvent=async(a,b)=>{try{console.log(`Mempersiapkan pengiriman event '${a}'...`);const c=getClientInfo(),d={eventName:a,eventId:crypto.randomUUID(),eventData:{value:b.value??1,currency:b.currency??"IDR",contentType:b.contentType??"page",contents:b.contents??null,...b},clientInfo:c};const e=await fetch("https://psstmdfdoantnlmicvcp.supabase.co/functions/v1/events-log",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});if(!e.ok)throw new Error(`Events Log API error: ${e.statusText}`);const f=await e.json();console.log(`✅ Event '${a}' berhasil dikirim ke events-log:`,f)}catch(a){console.error("❌ Gagal mengirim event tracking:",a)}};leadForm&&leadForm.addEventListener("submit",async a=>{a.preventDefault(),setFormStatus(!1);if(!validateForm())return void setFormStatus(!1,"Harap isi semua kolom dengan format yang benar.");setFormStatus(!0);const b=new FormData(leadForm),c={nama:b.get("nama")?.toString().trim()||"",email:b.get("email")?.toString().trim()||"",phone:b.get("phone")?.toString().trim()||""};try{const a=await fetch("https://shoper-api-endpoint-vercel.vercel.app/api/collect-lead",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}),d=await a.json();setFormStatus(!1),a.ok&&d.success?(await trackEvent("Lead",c),showModal(),leadForm.reset()):(setFormStatus(!1,"Email sudah terdaftar"===d.error?"Email ini sudah terdaftar. Silakan gunakan email lain.":"Terjadi kesalahan saat pengiriman data. Silakan coba lagi."),console.error("Server error:",d.error||"Unknown error"))}catch(a){setFormStatus(!1,"Gagal mengirim data. Silakan periksa koneksi internet Anda."),console.error("Request error:",a)}});function setFormStatus(a,b=null){if(loadingMsg)loadingMsg.style.display=a?"block":"none";if(errorMsg)errorMsg.textContent=b||"",errorMsg.style.display=b?"block":"none";const c=leadForm.querySelector('button[type="submit"]');c&&(c.disabled=a)}function validateForm(){let a=!0;return leadForm.querySelectorAll("input[required]").forEach(b=>{const c=document.getElementById(`err-${b.id}`);b.checkValidity()?(b.classList.remove("invalid"),c&&"none"!==c.style.display&&(c.style.display="none")):(b.classList.add("invalid"),c&&"block"!==c.style.display&&(c.style.display="block"),a=!1)}),a}function showModal(){modalOverlay&&modalOverlay.classList.add("show")}function closeModal(){modalOverlay&&modalOverlay.classList.remove("show"),closeModalBtn&&closeModalBtn.classList.remove("visible")}const closeModalBtn=document.getElementById("closeModalBtn");if(closeModalBtn)closeModalBtn.addEventListener("click",closeModal);if(installBtn&&closeModalBtn)installBtn.addEventListener("click",()=>{closeModalBtn.classList.add("visible")});window.addEventListener("load",()=>{trackEvent("PageView",{page_title:document.title,page_location:window.location.href,referrer:document.referrer})});let hasViewedContent=!1;const handleScroll=()=>{if(hasViewedContent)return void window.removeEventListener("scroll",handleScroll);const a=document.documentElement.scrollHeight-window.innerHeight,b=(a>0?window.scrollY/a:0)*100;b>=80&&(trackEvent("ViewContent",{value:1,currency:"IDR",contentType:"product",contents:[{id:"PAGEVIEW-DEFAULT",content_id:"PAGEVIEW-DEFAULT",quantity:1,price:1}],page_title:document.title,page_location:window.location.href}),hasViewedContent=!0,console.log("✅ Event ViewContent berhasil dikirim setelah mencapai 80% scroll"))};window.addEventListener("scroll",handleScroll);